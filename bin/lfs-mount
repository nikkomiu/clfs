#!/bin/bash

. "$(dirname -- "${BASH_SOURCE[0]}")/lfs-config"

mount_usage() {
  echo "Mount the LFS partitions"
  echo
  echo "The partitions will be mounted under the LFS working directory ($LFS)"
  echo
  echo "Arguments:"
  echo "  -h, --help    display this help and exit"
  echo "  -V, --no-virt do not mount virtual filesystems"
}

POSITIONAL_ARGS=()

while [[ $# -gt 0 ]]; do
  case $1 in
    -h|--help)
      mount_usage
      exit 0
      ;;
    -V|--no-virt)
      NO_VIRT=1
      shift # past argument
      ;;
    -*|--*)
      echo "Unknown option $1"
      echo
      mount_usage
      exit 1
      ;;
    *)
      POSITIONAL_ARGS+=("$1") # save positional arg
      shift # past argument
      ;;
  esac
done

set -- "${POSITIONAL_ARGS[@]}" # restore positional parameters

mkdir -pv $LFS
mount -v -t ext4 /dev/disk/by-uuid/$disk_root_uuid $LFS

mkdir -pv $LFS/boot/efi
mount -v -t vfat /dev/disk/by-uuid/$disk_efi_uuid $LFS/boot/efi

if [[ $NO_VIRT -ne 1 ]]; then
  # create directories for virtual filesystems
  mkdir -pv $LFS/{dev,proc,sys,run}

  mount -v --bind /dev $LFS/dev
  mount -vt devpts devpts -o gid=5,mode=0620 $LFS/dev/pts
  mount -vt proc proc $LFS/proc
  mount -vt sysfs sysfs $LFS/sys
  mount -vt tmpfs tmpfs $LFS/run
  if [ -h $LFS/dev/shm ]; then
    install -v -d -m 1777 $LFS$(realpath /dev/shm)
  else
    mount -vt tmpfs -o nosuid,nodev tmpfs $LFS/dev/shm
  fi
fi
